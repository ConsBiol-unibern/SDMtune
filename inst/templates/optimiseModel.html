<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script type="application/javascript">{{{ jQuery }}}</script>
	<script type="application/javascript">{{{ chartJs }}}</script>
	<title>Model optimization</title>
	<style>
	canvas {
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
	<style type="text/css">{{{ style }}}</style>
</head>

<body>
	<div class="content">
		<div class="row">
			<canvas id="scatter"></canvas>
		</div>
		<div class="row">
			<canvas id="line"></canvas>
		</div>
	</div>

	<script>
		var totModels = {{ tot_models }};
		var data = {};
		var scatterData = {
			datasets: [{
				label: "Training",
				pointRadius: 3,
				pointHoverRadius: 5,
				borderColor: "rgb(75, 192, 192)",
				backgroundColor: "rgba(75, 192, 192, .7)",
				data: []
			}]
		};
		// Add Validation dataset if metric in not AICc
		if ("{{ metric }}" !== "AICc") {
			scatterData.datasets.push({
				label: "Validation",
				pointRadius: 3,
				pointHoverRadius: 5,
				borderColor: "rgb(245, 132, 16)",
				backgroundColor: "rgba(245, 132, 16, .7)",
				data: []
			})
		}

		var lineData = {
		    labels: {{{ labels }}},
			datasets: [{
				label: "Training",
				pointRadius: 3,
				pointHoverRadius: 5,
				borderWidth: .7,
				borderColor: "rgb(75, 192, 192)",
				backgroundColor: "rgba(75, 192, 192, .7)",
				data: [],
				fill: false,
				lineTension: 0
			}]
		};
		// Add Validation dataset if metric in not AICc
		if ("{{ metric }}" !== "AICc") {
			lineData.datasets.push({
				label: "Validation",
				pointRadius: 3,
				pointHoverRadius: 5,
				borderWidth: .5,
				borderColor: "rgb(245, 132, 16)",
				backgroundColor: "rgba(245, 132, 16, .7)",
				data: [],
				fill: false,
				lineTension: 0
			})
		}

		var scatterOptions = {
			responsive: true,
			title: {
				display: true,
				fontFamily: "sans-serif",
				padding: 15,
				text: "Model Optimization - Generation 0"
			},
			legend: {
				display: false
			},
			scales: {
				yAxes: [{
					scaleLabel: {
						display: true,
						labelString: "{{ metric }}"
					}
				}],
				xAxes: [{
					scaleLabel: {
						display: true,
						labelString: "model"
					},
					ticks: {
						max: parseInt("{{ pop }}"),
						callback: function(value) {
							if (value % 1 === 0) {
								return value;
							}
						}
					}
				}]
			},
			tooltips: {
				mode: "x",
				footerFontStyle: "normal",
				callbacks: {
					label: function(tooltipItem, data) {
						var label = data.datasets[tooltipItem.datasetIndex].label || '';
						if (label) {
							label += ": ";
						}
						label += tooltipItem.yLabel;
						return label;
					},
					footer: function(tooltipItems, data) {
						return window.data.scatterFooter[tooltipItems[0].index]
					}
				}
			}
		};

		var lineOptions = {
			responsive: true,
			title: {
				display: false
			},
			legend: {
				position: "bottom",
				labels: {
					fontFamily: "sans-serif",
					usePointStyle: true
				}
			},
			scales: {
				yAxes: [{
					scaleLabel: {
						display: true,
						labelString: "{{ metric }}"
					}
				}],
				xAxes: [{
					scaleLabel: {
						display: true,
						labelString: "generation"
					}
				}]
			},
			tooltips: {
				mode: "x",
				footerFontStyle: "normal",
				callbacks: {
					label: function(tooltipItem, data) {
						var label = data.datasets[tooltipItem.datasetIndex].label || '';
						if (label) {
							label += ": ";
						}
						label += tooltipItem.yLabel;
						return label;
					},
					title: function(tooltipItems, data) {
						return window.data.lineTitle[tooltipItems[0].index]
					}
				}
			}
		};

		update = function() {
			var refresh = setInterval(loadData, 1000);
			function loadData() {
				$.ajax({
					method: "GET",
					url: "data.json",
					cache: false
				})
				.done(function (json) {
					data = JSON.parse(json);
					window.chartScatter.data.datasets[0].data = data.train;
					if ("{{ metric }}" !== "AICc") {
						window.chartScatter.data.datasets[1].data = data.val;
					}
					window.chartScatter.options.title.text = "Model optimization - Generation " + data.gen;
					window.chartScatter.update();

					window.chartLine.data.datasets[0].data = data.best_train;
					if ("{{ metric }}" !== "AICc") {
						window.chartLine.data.datasets[1].data = data.best_val;
					}
					window.chartLine.update();

					if (data.stop) {
						clearInterval(refresh);
					}
				})
			};
		};

		window.onload = function() {
			// Set a wider content if page is displayed in the browser
			if (window.location.href.search("[?&]viewer_pane=") === -1) {
				document.querySelector(".content").style.maxWidth="600px";
			}
			var ctx1 = document.getElementById("scatter").getContext("2d");
			window.chartScatter = new Chart(ctx1, {
				type: "scatter",
				data: scatterData,
				options: scatterOptions,
			});
			var ctx2 = document.getElementById("line").getContext("2d");
			window.chartLine = new Chart(ctx2, {
				type: "line",
				data: lineData,
				options: lineOptions,
			});
			update();
		};

	</script>
</body>

</html>
